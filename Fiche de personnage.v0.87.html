<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche SCCS - Module Codex v0.87</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,700&family=Spectral:wght@600;700;800&display=swap" rel="stylesheet">
    
    <script src="registre.js"></script>

    <style>
        /* === CONFIGURATION "FRAME ONLY" === */
        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            padding: 0; 
            background-color: transparent; 
            font-family: 'Cormorant Garamond', serif;
            color: #000000;
            height: 100vh;
            overflow: hidden; 
        }

        /* Conteneur A4 Fixe */
        .sheet-container {
            width: 794px;  /* 210mm @ 96dpi */
            height: 1123px; /* 297mm */
            padding: 10mm 15mm; 
            background-color: #c5a880;
            background-image: url("https://www.transparenttextures.com/patterns/clean-gray-paper.png");
            background-blend-mode: multiply;
            position: relative; 
            overflow: hidden; 
        }

        .layout-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* --- STYLES INTERNES --- */
        table { border-collapse: collapse; width: 100%; }
        td { vertical-align: top; }
        .font-title { font-family: 'Cinzel', serif; }
        .font-body { font-family: 'Cormorant Garamond', serif; }
        .font-digit { font-family: 'Spectral', serif; }
        ::placeholder { color: #000000 !important; opacity: 0.6; font-style: italic; }
        input, select { color: #000000; }

        .header-actions { display: flex; gap: 5px; }
        .btn-action {
            cursor: pointer; opacity: 0.4; transition: opacity 0.2s, color 0.2s;
            padding: 0 2px; font-size: 1.1rem;
            color: #000000; background: none; border: none;
        }
        .btn-action:hover { opacity: 1; }
        .btn-reset:hover { color: #ea580c; }
        .btn-export:hover { color: #2563eb; }
        .btn-import:hover { color: #16a34a; }

        .stat-digit {
            font-family: 'Spectral', serif !important; font-weight: 700 !important; 
            font-size: 2.2rem !important; line-height: 1 !important;
            display: inline-block; transform: translateY(1px); 
            color: #000000 !important;
        }
        .label-cell {
            padding: 4px 0 4px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.4);
            vertical-align: baseline; font-size: 0.8rem; font-weight: 800;
            text-transform: uppercase; color: #000000; white-space: nowrap; font-family: 'Cinzel', serif;
        }
        .value-cell {
            padding: 0 5px 0 0; border-bottom: 1px solid rgba(0, 0, 0, 0.4);
            vertical-align: baseline; width: 50px; text-align: right;
        }
        .clean-input {
            width: 100%; background: transparent; border: none; outline: none;
            text-align: right; font-weight: 700; font-size: 1.6rem; color: #000000;
            font-family: 'Spectral', serif; padding: 0; margin: 0; 
            line-height: 1.2; vertical-align: baseline;
        }
        .identity-select, .identity-input {
            appearance: none; background: transparent; border: none;
            border-bottom: 2px solid rgba(0, 0, 0, 0.5); width: 100%;
            padding: 0; height: 30px; vertical-align: bottom; border-radius: 0; color: #000000; outline: none;
        }
        .identity-select { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.2rem; }
        .identity-input { font-family: 'Spectral', serif; font-weight: 700; font-size: 1.2rem; }

        .check-box {
            width: 14px; height: 14px; border: 2px solid #000000;
            display: inline-flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.3); margin-right: 8px; cursor: pointer;
            vertical-align: middle; 
        }
        .check-box.active { background: #000000; }
        .check-box.active::after { content: "‚úì"; color: #fff; font-size: 12px; line-height: 1; }

        .area-textarea {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.3);
            width: 100%; height: 50mm; resize: none; padding: 0 8px;
            font-family: 'Cormorant Garamond', serif; font-weight: 600; font-size: 1.2rem;
            color: #000000; line-height: 30px;
            background-image: linear-gradient(transparent 29px, rgba(0, 0, 0, 0.2) 30px);
            background-size: 100% 30px; background-attachment: local;
            display: block; margin-top: 4px; overflow: hidden; outline: none;
        }
        .box-cell {
            border: 2px solid rgba(0, 0, 0, 0.3);
            background-color: rgba(255,255,255,0.1);
            border-radius: 4px; padding: 8px;
        }
        .spacer-row { height: 5px; } 
        
        .footer-absolute {
            position: absolute; bottom: 10mm; left: 15mm; right: 15mm;   
            height: 20px; text-align: center;
        }
        .portrait-img-custom {
            width: 100%; height: 100%; object-fit: cover;
            filter: sepia(0.2) contrast(1.1) brightness(0.9); mix-blend-mode: multiply;
        }
    </style>
</head>
<body class="font-body text-black">

    <div class="layout-wrapper">
        <div class="sheet-container">
            <input type="file" id="file-upload" style="display:none" accept=".json" onchange="handleFileUpload(this)">

            <table style="width: 100%;">
                <tr style="height: 175px;">
                    <td style="width: 160px; padding-right: 25px;">
                        <table style="width:100%; height:175px; border: 4px solid rgba(0, 0, 0, 0.6);">
                            <tr>
                                <td style="padding:4px;">
                                    <div id="portrait-container" style="width:100%; height:100%; border: 2px dashed rgba(0, 0, 0, 0.4); display:flex; align-items:center; justify-content:center; overflow:hidden;"></div>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td style="vertical-align: bottom;">
                        <table style="height: 100%;">
                            <tr>
                                <td colspan="3" style="vertical-align: top;">
                                    <div class="flex justify-between items-end">
                                        <label class="block text-xs font-black uppercase tracking-[0.3em] font-title text-black">Nom du personnage</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="text" id="char-name" class="w-full bg-transparent border-b-4 border-black/60 text-4xl font-black py-1 font-title outline-none text-black placeholder-black" placeholder="" oninput="updateProfileName(this.value)">
                                        <div class="header-actions ml-2">
                                            <button onclick="resetSheet()" class="btn-action btn-reset" title="Effacer le contenu">‚Ü∫</button>
                                            <span style="color:#000; font-size:1.1rem; cursor:default;">|</span> 
                                            <button onclick="exportSingleJSON()" class="btn-action btn-export" title="Sauvegarder JSON local">üíæ</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr style="height: 50px;">
                                <td style="padding-right: 15px; vertical-align: bottom;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title text-black">Esp√®ce</label>
                                    <select id="race-select" class="identity-select" onchange="updateRace(); updatePortrait()">
                                        <option value="HUMAIN">HUMAIN</option>
                                        <option value="ELFE">ELFE</option>
                                        <option value="NAIN">NAIN</option>
                                        <option value="ORQUE">ORQUE</option>
                                    </select>
                                </td>
                                <td style="padding-right: 15px; vertical-align: bottom;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title text-black">Genre</label>
                                    <select id="gender-select" class="identity-select" onchange="updatePortrait()">
                                        <option value="MASCULIN">MASCULIN</option>
                                        <option value="F√âMININ">F√âMININ</option>
                                    </select>
                                </td>
                                <td style="width: 70px; vertical-align: bottom;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title text-black">PA</label>
                                    <input type="number" id="val-pa" class="identity-input text-left" value="0">
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding-top: 15px;">
                                    <table>
                                        <tr>
                                            <td class="text-[10px] font-bold w-28 py-1 align-baseline border-b border-black/30 text-black">COULEUR DES YEUX:</td>
                                            <td class="border-b border-black/30"><input type="text" id="identity-eyes" class="w-full bg-transparent outline-none italic font-bold placeholder-black" placeholder=""></td>
                                        </tr>
                                        <tr>
                                            <td class="text-[10px] font-bold w-28 py-1 align-baseline border-b border-black/30 text-black">CHEVEUX:</td>
                                            <td class="border-b border-black/30"><input type="text" id="identity-hair" class="w-full bg-transparent outline-none italic font-bold placeholder-black" placeholder=""></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>

                <tr class="spacer-row"><td></td><td></td></tr>

                <tr>
                    <td colspan="2">
                        <table style="table-layout: fixed;">
                            <tr>
                                <td style="width: 48%; padding-right: 2%;">
                                    <h2 class="font-title text-xl font-black uppercase border-l-4 border-black pl-3 mb-2 text-black">‚öîÔ∏è Attaque</h2>
                                    <table style="width:100%; border:1px solid rgba(0, 0, 0, 0.3); background-color: rgba(0,0,0,0.05); border-radius:4px;">
                                        <tr>
                                            <td style="padding:10px;">
                                                <table style="table-layout: fixed;">
                                                    <tr>
                                                        <td style="padding-right: 15px;">
                                                            <p class="text-[9px] font-black uppercase mb-1 border-b border-black/40 text-black">Type</p>
                                                            <table>
                                                                <tr style="height: 34px;"><td class="label-cell">Direct</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Circulaire</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Saisie</td><td class="value-cell"><input type="number" id="stat-att-saisie" class="clean-input" value="0"></td></tr>
                                                            </table>
                                                        </td>
                                                        <td>
                                                            <p class="text-[9px] font-black uppercase mb-1 border-b border-black/40 text-black">Cible</p>
                                                            <table>
                                                                <tr style="height: 34px;"><td class="label-cell">T√™te</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Tronc</td><td class="value-cell"><input type="number" id="stat-att-tronc" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Membres</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                
                                <td style="width: 48%; padding-left: 2%;">
                                    <h2 class="font-title text-xl font-black uppercase border-l-4 border-black pl-3 mb-2 text-black">üõ°Ô∏è Protection</h2>
                                    <table style="width:100%; border:1px solid rgba(0, 0, 0, 0.3); background-color: rgba(0,0,0,0.05); border-radius:4px;">
                                        <tr>
                                            <td style="padding:10px;">
                                                <table style="table-layout: fixed; width: 100%;">
                                                    <tr>
                                                        <td style="padding-right: 15px; vertical-align: top;">
                                                            <div class="flex items-end border-b border-black/40 mb-1" style="height: 15px;">
                                                                <div class="text-[9px] font-black uppercase text-black flex-grow">D√©fense</div>
                                                            </div>
                                                            <table style="width: 100%;">
                                                                <tr style="height: 34px;"><td class="label-cell"><span style="font-size:0.7em; margin-right:1px;">vs</span> Direct</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell"><span style="font-size:0.7em; margin-right:1px;">vs</span> Circu.</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell"><span style="font-size:0.7em; margin-right:1px;">vs</span> Saisie</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                            </table>
                                                        </td>
                                                        <td style="vertical-align: top;">
                                                            <div class="flex items-end border-b border-black/40 mb-1" style="height: 15px;">
                                                                <div class="text-[9px] font-black uppercase text-black flex-grow">R√©sistance</div>
                                                                <div class="text-[8px] font-black uppercase text-black text-center w-[32px] pb-[1px]">Nat.</div>
                                                                <div class="text-[8px] font-black uppercase text-black text-center w-[38px] pb-[1px]">Arm.</div>
                                                            </div>
                                                            <table style="width: 100%;">
                                                                <colgroup><col><col style="width: 32px;"><col style="width: 38px;"></colgroup>
                                                                <tr style="height: 34px;"><td class="label-cell">T√™te</td><td class="value-cell" style="padding-right: 2px;"><input type="number" id="res-nat-tete" class="clean-input" value="0"></td><td style="border-bottom: 1px solid rgba(0, 0, 0, 0.4); vertical-align: bottom; text-align: left; padding-left: 2px; white-space: nowrap;"><span class="font-digit font-bold text-black text-[1.6rem] leading-[1.2] align-baseline">+</span><span id="res-arm-tete" class="font-digit font-bold text-black text-[1.6rem] leading-[1.2] align-baseline">0</span></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Tronc</td><td class="value-cell" style="padding-right: 2px;"><input type="number" id="res-nat-tronc" class="clean-input" value="0"></td><td style="border-bottom: 1px solid rgba(0, 0, 0, 0.4); vertical-align: bottom; text-align: left; padding-left: 2px; white-space: nowrap;"><span class="font-digit font-bold text-black text-[1.6rem] leading-[1.2] align-baseline">+</span><span id="res-arm-tronc" class="font-digit font-bold text-black text-[1.6rem] leading-[1.2] align-baseline">0</span></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Membres</td><td class="value-cell" style="padding-right: 2px;"><input type="number" id="res-nat-membres" class="clean-input" value="0"></td><td style="border-bottom: 1px solid rgba(0, 0, 0, 0.4); vertical-align: bottom; text-align: left; padding-left: 2px; white-space: nowrap;"><span class="font-digit font-bold text-black text-[1.6rem] leading-[1.2] align-baseline">+</span><span id="res-arm-membres" class="font-digit font-bold text-black text-[1.6rem] leading-[1.2] align-baseline">0</span></td></tr>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>

                <tr class="spacer-row"><td></td><td></td></tr>

                <tr>
                    <td colspan="2">
                        <table style="table-layout: fixed;">
                            <tr>
                                <td style="width: 65%; padding-right: 2%;">
                                    <table style="width:100%; margin-bottom: 8px;">
                                        <tr>
                                            <td class="box-cell">
                                                <div class="mb-2 border-b border-black/20 pb-1 flex justify-between items-end">
                                                    <span class="font-title font-black uppercase text-xs text-black">Armes</span>
                                                </div>
                                                <table style="width:100%; table-layout: fixed;">
                                                    <tr>
                                                        <td style="width:50%; padding-right:5px;">
                                                            <label class="block text-[8px] font-black uppercase text-black">Main Droite</label>
                                                            <select id="weapon-select-1" class="w-full bg-transparent font-title font-bold text-sm border-b border-black/40 outline-none text-black truncate" onchange="updateUI()">
                                                            </select>
                                                        </td>
                                                        <td style="width:50%; padding-left:5px;">
                                                            <label class="block text-[8px] font-black uppercase text-black">Main Gauche</label>
                                                            <select id="offhand-select-1" class="w-full bg-transparent font-title font-bold text-sm border-b border-black/40 outline-none text-black truncate" onchange="updateUI()">
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="2" style="padding-top:4px;">
                                                            <div class="flex justify-between items-center bg-black/5 rounded px-2 py-1">
                                                                <div class="flex items-center">
                                                                    <span id="init-label-1" class="font-title font-bold uppercase text-[8px] text-black mr-2">Initiative</span>
                                                                    <span id="init-val-1" class="font-digit font-bold text-sm text-black">0</span>
                                                                </div>
                                                                <div class="flex items-center">
                                                                    <span class="font-title font-bold uppercase text-[8px] text-black mr-1">Malus Magie</span>
                                                                    <span id="magic-malus-1" class="font-digit font-bold text-sm text-black">0</span>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>

                                                <div class="pl-1 my-1">
                                                    <span class="text-[9px] font-bold text-black italic lowercase">ou</span>
                                                </div>

                                                <table style="width:100%; table-layout: fixed;">
                                                    <tr>
                                                        <td style="width:50%; padding-right:5px;">
                                                            <label class="block text-[8px] font-black uppercase text-black">Main Droite</label>
                                                            <select id="weapon-select-2" class="w-full bg-transparent font-title font-bold text-sm border-b border-black/40 outline-none text-black truncate" onchange="updateUI()">
                                                            </select>
                                                        </td>
                                                        <td style="width:50%; padding-left:5px;">
                                                            <label class="block text-[8px] font-black uppercase text-black">Main Gauche</label>
                                                            <select id="offhand-select-2" class="w-full bg-transparent font-title font-bold text-sm border-b border-black/40 outline-none text-black truncate" onchange="updateUI()">
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="2" style="padding-top:4px;">
                                                            <div class="flex justify-between items-center bg-black/5 rounded px-2 py-1">
                                                                <div class="flex items-center">
                                                                    <span id="init-label-2" class="font-title font-bold uppercase text-[8px] text-black mr-2">Initiative</span>
                                                                    <span id="init-val-2" class="font-digit font-bold text-sm text-black">0</span>
                                                                </div>
                                                                <div class="flex items-center">
                                                                    <span class="font-title font-bold uppercase text-[8px] text-black mr-1">Malus Magie</span>
                                                                    <span id="magic-malus-2" class="font-digit font-bold text-sm text-black">0</span>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>

                                    <table style="width:100%; margin-bottom: 8px;">
                                        <tr>
                                            <td class="box-cell">
                                                <div class="mb-2 border-b border-black/20 pb-1 flex justify-between items-end">
                                                    <span class="font-title font-black uppercase text-xs text-black">Protection</span>
                                                </div>

                                                <table style="width:100%;">
                                                    <tr>
                                                        <td>
                                                            <label class="block text-[8px] font-black uppercase text-black">Type d'armure</label>
                                                            <select id="armor-select" class="w-full bg-transparent font-title font-bold text-base border-b border-black/40 outline-none text-black" onchange="updateUI()">
                                                                <option value="Aucune">Sans Armure</option>
                                                                <option value="L√©g√®re">Cuir sans Heaume</option>
                                                                <option value="L√©g√®re_Heaume">Cuir avec Heaume</option>
                                                                <option value="Moyenne">Mailles sans Heaume</option>
                                                                <option value="Moyenne_Heaume">Mailles avec Heaume</option>
                                                                <option value="Lourde">Harnois sans Heaume</option>
                                                                <option value="Lourde_Heaume">Harnois avec Heaume</option>
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="padding-top: 4px;">
                                                            <div class="flex justify-between items-center bg-black/5 rounded px-2 py-1">
                                                                <div class="flex items-center">
                                                                    <span class="font-title font-bold uppercase text-[8px] text-black mr-2">Durabilit√©</span>
                                                                    <span id="dur-display" class="font-digit font-bold text-sm text-black">0/0</span>
                                                                </div>
                                                                <div class="flex items-center">
                                                                    <span class="font-title font-bold uppercase text-[8px] text-black mr-1">Malus Magie</span>
                                                                    <span id="magic-malus-armor" class="font-digit font-bold text-sm text-black">0</span>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                </td>

                                <td style="width: 35%; padding-left: 2%; border-left: 2px solid rgba(0, 0, 0, 0.2); vertical-align: top;">
                                    <h2 class="font-title text-sm font-black uppercase border-b-2 border-black/40 pb-1 mb-2 text-black">Talents</h2>
                                    <div id="talents-container"></div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>

                <tr class="spacer-row"><td></td><td></td></tr>

                <tr>
                    <td colspan="2">
                        <div style="width: 100%;">
                            <h3 class="font-title text-xs font-black uppercase mb-1 text-black">Notes</h3>
                            <textarea class="area-textarea"></textarea>
                        </div>
                    </td>
                </tr>
            </table>
            
            <div class="footer-absolute">
                <div class="text-[9px] text-center text-black uppercase font-black tracking-widest pt-1 border-t border-black/30">
                    Grimoire SCCS VLU Officiel - Fiche Personnage
                </div>
            </div>
        </div>
    </div>

    <script>
        // === LOGIQUE DE GESTION PAR "REGISTRE.JS" ===
        let currentUid = null;

        // Configuration visuelle
        const CUSTOM_PORTRAITS_URLS = {
            "HUMAIN_MASCULIN": "portraits/portrait_homme_humain.png",
            "HUMAIN_F√âMININ": "portraits/portrait_femme_humain.png",
            "ELFE_MASCULIN": "portraits/portrait_homme_elfe.png",
            "ELFE_F√âMININ": "portraits/portrait_femme_elfe.png",
            "NAIN_MASCULIN": "portraits/portrait_homme_nain.png",
            "NAIN_F√âMININ": "portraits/portrait_femme_nain.png",
            "ORQUE_MASCULIN": "portraits/portrait_homme_orque.png",
            "ORQUE_F√âMININ": "portraits/portrait_femme_orque.png",
        };

        const state = {
            talents: {
                athletisme: false, acrobatie: false, mecanique: false,
                subtilite: false, perception: false, survie: false,
                savoir_acad: false
            }
        };

        // --- INIT ---
        window.onload = function() {
            initWeaponSelect();
            
            // R√©cup√©ration de l'ID depuis l'URL (envoy√© par le Livre)
            const params = new URLSearchParams(window.location.search);
            currentUid = params.get('uid');

            if (currentUid && typeof SCCS_Registre !== 'undefined') {
                loadFromRegistry(currentUid);
                // Activer l'√©couteur de changement global
                setupAutoSave();
            } else {
                console.warn("Fiche ouverte sans ID ou Registre manquant.");
            }
        };

        // --- CHARGEMENT ---
        function loadFromRegistry(uid) {
            const profile = SCCS_Registre.getProfile(uid);
            if (!profile) return;

            const data = profile.content || {};
            
            // Remplissage des champs
            document.querySelectorAll('input, textarea').forEach(el => { el.value = ''; });
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            document.querySelectorAll('input[type=number]').forEach(el => el.value = '0');

            // Valeurs par d√©faut armes
            if(document.getElementById('weapon-select-1')) document.getElementById('weapon-select-1').value = "Main Libre";
            if(document.getElementById('weapon-select-2')) document.getElementById('weapon-select-2').value = "Main Libre";

            // Injection des donn√©es
            Object.keys(data).forEach(key => {
                if (key.startsWith('__clean_input_')) {
                    const idx = parseInt(key.replace('__clean_input_', ''));
                    const els = document.querySelectorAll('.clean-input:not([id])');
                    if (els[idx]) els[idx].value = data[key];
                } 
                else if (key.startsWith('__area_')) {
                    const idx = parseInt(key.replace('__area_', ''));
                    const els = document.querySelectorAll('.area-textarea:not([id])');
                    if (els[idx]) els[idx].value = data[key];
                }
                else {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.type === 'checkbox') el.checked = data[key];
                        else el.value = data[key];
                    }
                }
            });

            // Restauration Talents
            if (data.__state_talents) {
                state.talents = JSON.parse(JSON.stringify(data.__state_talents));
            } else {
                updateRace(); // D√©faut
            }

            // Mise √† jour visuelle
            updateOffhandOptions(1);
            updateOffhandOptions(2);
            updateUI();
            updatePortrait();
        }

        // --- SAUVEGARDE AUTOMATIQUE ---
        function setupAutoSave() {
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('input', triggerSave);
                el.addEventListener('change', triggerSave);
            });
        }

        function triggerSave() {
            if (!currentUid || typeof SCCS_Registre === 'undefined') return;

            const data = {};
            // Collecte des IDs
            document.querySelectorAll('input[id], select[id], textarea[id]').forEach(el => {
                if(el.type === 'checkbox') data[el.id] = el.checked;
                else data[el.id] = el.value;
            });
            // Collecte des champs sans IDs
            document.querySelectorAll('.clean-input:not([id])').forEach((el, index) => {
                data[`__clean_input_${index}`] = el.value;
            });
             document.querySelectorAll('.area-textarea:not([id])').forEach((el, index) => {
                data[`__area_${index}`] = el.value;
            });
            
            data.__state_talents = state.talents;

            // R√©cup√©ration du nom pour le sommaire
            const nameVal = document.getElementById('char-name').value || "Sans Nom";

            // Envoi au Cerveau
            SCCS_Registre.updateProfile(currentUid, data, nameVal);
        }

        // --- ACTIONS LOCALES ---
        function updateProfileName(val) { triggerSave(); }

        function resetSheet() {
            if (!confirm("Voulez-vous vider les champs de cette fiche ?")) return;
            document.querySelectorAll('input, textarea').forEach(el => { el.value = ''; });
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            document.querySelectorAll('input[type=number]').forEach(el => el.value = '0');
            state.talents = {
                athletisme: false, acrobatie: false, mecanique: false,
                subtilite: false, perception: false, survie: false,
                savoir_acad: false
            };
            updateUI();
            updatePortrait();
            triggerSave();
        }

        function exportSingleJSON() {
            if (!currentUid) return;
            const profile = SCCS_Registre.getProfile(currentUid);
            if (!profile) return;
            
            const dataStr = JSON.stringify(profile, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SCCS_Heros_${profile.name.replace(/\s+/g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- LOGIQUE M√âTIER (R√àGLES JDR) ---
        const WEAPONS_DATA = {
            "Distance": { label: "Armes √† Distance", stats: { init: "1/7", magie: -1 }, items: ["Arc", "Arbal√®te", "Fronde"] },
            "Focalisateur": { label: "Focalisateurs", stats: { init: "6", magie: 0 }, items: ["Grimoire", "Chapelet", "B√¢ton"] },
            "Longue": { label: "Armes Longues (2 mains)", stats: { init: "4", magie: -1 }, items: ["Lance (Longue)", "√âp√©e √† deux mains", "Hache √† deux mains", "Masse √† deux mains"] },
            "Moyenne": { label: "Armes Moyennes (1 main)", stats: { init: "5", magie: -1 }, items: ["√âp√©e", "Hache", "Masse", "Lance (1 main)", "Fl√©au"] },
            "Courte": { label: "Armes Courtes", stats: { init: "6", magie: -1 }, items: ["Dague", "√âp√©e courte", "Torche", "Main Libre"] }
        };

        const RULES = {
            ARMORS: {
                "Aucune": { dur: 0, res: 0, malus: [] },
                "L√©g√®re": { dur: 6, res: 1, malus: ["acrobatie", "athletisme", "magie"] },
                "L√©g√®re_Heaume": { dur: 6, res: 1, malus: ["acrobatie", "athletisme", "magie", "perception", "acrobatie"] }, 
                "Moyenne": { dur: 8, res: 2, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "magie"] },
                "Moyenne_Heaume": { dur: 8, res: 2, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "magie", "perception", "acrobatie"] },
                "Lourde": { dur: 10, res: 3, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "perception", "magie"] },
                "Lourde_Heaume": { dur: 10, res: 3, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "perception", "magie", "perception", "acrobatie"] } 
            },
            RACES: {
                "ELFE": ["acrobatie", "perception", "survie"],
                "NAIN": ["athletisme", "mecanique", "savoir_acad"],
                "ORQUE": ["athletisme", "survie"],
                "HUMAIN": []
            }
        };

        const talentsList = [
            { id: 'athletisme', label: 'Athl√©tisme' },
            { id: 'acrobatie', label: 'Acrobatie' },
            { id: 'mecanique', label: 'M√©canique' },
            { id: 'subtilite', label: 'Subtilit√©' },
            { id: 'perception', label: 'Perception' },
            { id: 'survie', label: 'Survie' },
            { id: 'savoir_acad', label: 'Savoir Acad.' }
        ];

        function initWeaponSelect() {
            [1, 2].forEach(index => {
                const select = document.getElementById(`weapon-select-${index}`);
                if (!select) return;
                select.innerHTML = '';
                for (const [key, category] of Object.entries(WEAPONS_DATA)) {
                    const group = document.createElement('optgroup');
                    group.label = category.label;
                    category.items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = item;
                        group.appendChild(option);
                    });
                    select.appendChild(group);
                }
                select.value = "Main Libre";
            });
            updateUI();
        }

        function getWeaponStats(weaponName) {
            if (weaponName === "Grimoire" || weaponName === "Chapelet" || weaponName === "B√¢ton") return { init: "6", magie: 0 };
            for (const [key, category] of Object.entries(WEAPONS_DATA)) {
                if (category.items.includes(weaponName)) return category.stats;
            }
            return { init: "-", magie: 0 };
        }

        function getWeaponCategory(weaponName) {
            for (const [key, category] of Object.entries(WEAPONS_DATA)) {
                if (category.items.includes(weaponName)) return key;
            }
            return "Courte";
        }

        function updateOffhandOptions(index) {
            const weaponSelect = document.getElementById(`weapon-select-${index}`);
            const offhandSelect = document.getElementById(`offhand-select-${index}`);
            if (!weaponSelect || !offhandSelect) return;

            const weaponName = weaponSelect.value;
            const category = getWeaponCategory(weaponName);
            const currentOffhand = offhandSelect.value;
            
            offhandSelect.innerHTML = ''; 
            offhandSelect.disabled = false;
            
            let options = [];
            if (category === "Distance" || category === "Longue") {
                options.push("Occup√©e");
                offhandSelect.disabled = true; 
            } 
            else if (category === "Focalisateur") {
                if (weaponName === "B√¢ton") {
                    options.push("Occup√©e ou Libre", "Bouclier", "Torche");
                } else {
                    options.push("Main Libre (Incantation)", "Bouclier", "Torche");
                }
            }
            else if (category === "Moyenne") {
                options.push("Main Libre", "Bouclier", "Torche");
            }
            else { 
                options.push("Main Libre", "Bouclier", "Torche");
                const shortWeapons = WEAPONS_DATA["Courte"].items;
                shortWeapons.forEach(wp => {
                    if (wp !== "Main Libre" && wp !== "Torche" && wp !== "Bouclier (Offensif)") options.push(wp); 
                });
            }

            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt; el.textContent = opt;
                offhandSelect.appendChild(el);
            });

            if (Array.from(offhandSelect.options).some(o => o.value === currentOffhand)) offhandSelect.value = currentOffhand;
            else offhandSelect.selectedIndex = 0;
        }

        function updatePortrait() {
            const race = document.getElementById('race-select')?.value;
            const gender = document.getElementById('gender-select')?.value;
            const container = document.getElementById('portrait-container');
            if(!race || !gender || !container) return;
            const key = `${race}_${gender}`;
            if (CUSTOM_PORTRAITS_URLS[key]) {
                container.innerHTML = `<img src="${CUSTOM_PORTRAITS_URLS[key]}" class="portrait-img-custom" alt="Portrait">`;
            } else {
                container.innerHTML = `<div style="text-transform:uppercase; font-size:10px; font-weight:bold; letter-spacing:0.1em; color:rgba(0,0,0, 0.8);">PORTRAIT</div>`;
            }
        }

        function updateRace() {
            const race = document.getElementById('race-select')?.value;
            if (!race) return;
            Object.keys(state.talents).forEach(k => state.talents[k] = false);
            if (RULES.RACES[race]) RULES.RACES[race].forEach(tid => state.talents[tid] = true);
            const saisieField = document.getElementById('stat-att-saisie');
            if(saisieField) saisieField.value = (race === "ORQUE") ? 1 : 0;
            triggerSave();
            updateUI();
        }

        function toggleTalent(id) {
            state.talents[id] = !state.talents[id];
            triggerSave();
            updateUI();
        }

        function updateUI() {
            [1, 2].forEach(index => {
                const weaponSelect = document.getElementById(`weapon-select-${index}`);
                const offhandSelect = document.getElementById(`offhand-select-${index}`);
                const initLabel = document.getElementById(`init-label-${index}`);
                
                if (weaponSelect && offhandSelect) {
                    const activeEl = document.activeElement;
                    if (activeEl === weaponSelect) updateOffhandOptions(index);
                    
                    const weaponName = weaponSelect.value;
                    const offhandName = offhandSelect.value;
                    const weaponStats = getWeaponStats(weaponName);
                    const cat = getWeaponCategory(weaponName);
                    
                    const isRightFree = weaponName === "Main Libre";
                    const isLeftFree = offhandName && (
                        offhandName.includes("Libre") || 
                        offhandName === "Occup√©e" ||
                        offhandName === "Occup√©e ou Libre"
                    );
                    const hasFreeHand = isRightFree || isLeftFree;
                    
                    const isRightCatalyst = weaponName !== "Main Libre" && weaponName !== "Torche";
                    const isLeftCatalyst = offhandName && offhandName !== "Main Libre" && offhandName !== "Main Libre (Incantation)" && offhandName !== "Bouclier" && offhandName !== "Torche" && offhandName !== "Occup√©e" && offhandName !== "Occup√©e ou Libre";
                    
                    const hasCatalyst = isRightCatalyst || isLeftCatalyst;
                    const canCast = hasFreeHand && hasCatalyst;

                    const initSpan = document.getElementById(`init-val-${index}`);
                    const rawInit = weaponStats.init;
                    
                    if (initSpan) {
                        initSpan.className = "font-digit font-bold text-sm text-black"; 

                        if (canCast) {
                            if (initLabel) initLabel.style.display = 'none'; 
                            let weaponInitDisplay = rawInit;
                            if (weaponName === "B√¢ton") {
                                weaponInitDisplay = `5 <span class="font-body font-bold text-[10px]">(1 main)</span> 4 <span class="font-body font-bold text-[10px]">(2 mains)</span>`;
                            }
                            initSpan.innerHTML = `
                                <span class="font-title font-bold text-[8px] mr-1">INITIATIVE :</span>
                                <span class="font-title font-bold text-[8px] mr-1">ARME</span>${weaponInitDisplay}
                                <span class="mx-1 opacity-50 font-sans">/</span>
                                <span class="font-title font-bold text-[8px] mr-1">SORT</span>2 <span class="font-body font-bold text-[10px]">(libre)</span> 8 <span class="font-body font-bold text-[10px]">(engag√©)</span>
                            `;
                        } else {
                            if (initLabel) initLabel.style.display = 'inline'; 
                            let standardDisplay = rawInit;
                            if (rawInit.includes('/')) {
                                const [v1, v2] = rawInit.split('/');
                                standardDisplay = `${v1} <span class="font-body font-bold text-[10px]">(libre)</span> ${v2} <span class="font-body font-bold text-[10px]">(engag√©)</span>`;
                            } 
                            else if (weaponName === "B√¢ton") {
                                standardDisplay = `5 <span class="font-body font-bold text-[10px]">(1 main)</span> 4 <span class="font-body font-bold text-[10px]">(2 mains)</span>`;
                            }
                            initSpan.innerHTML = standardDisplay;
                        }
                    }

                    const magicSpan = document.getElementById(`magic-malus-${index}`);
                    if(magicSpan) {
                        if (!hasFreeHand || !hasCatalyst) {
                            magicSpan.innerText = "lancement de sort impossible";
                            magicSpan.style.color = "#dc2626";
                            magicSpan.style.fontStyle = "normal";
                            magicSpan.style.fontSize = "0.6rem"; 
                        } else {
                            const val = (cat === "Focalisateur") ? 0 : weaponStats.magie;
                            magicSpan.innerText = val;
                            magicSpan.style.color = "#000000";
                            magicSpan.style.fontStyle = "normal";
                            magicSpan.style.fontSize = ""; 
                        }
                    }
                }
            });

            const armorEl = document.getElementById('armor-select');
            if (armorEl) {
                const armor = armorEl.value;
                const armorData = RULES.ARMORS[armor];
                const baseRes = armorData ? armorData.res : 0;
                const headRes = armor.includes("_Heaume") ? baseRes : 0;
                
                document.getElementById('res-arm-tete').innerText = headRes;
                document.getElementById('res-arm-tronc').innerText = baseRes;
                document.getElementById('res-arm-membres').innerText = baseRes;

                let malusArmure = 0;
                if (armorData && armorData.malus && armorData.malus.includes("magie")) malusArmure = -1;
                document.getElementById('magic-malus-armor').innerText = (malusArmure >= 0 ? "+" : "") + malusArmure;

                const maxDur = armorData ? armorData.dur : 0;
                document.getElementById('dur-display').innerText = `${maxDur}/${maxDur}`;

                const container = document.getElementById('talents-container');
                if (container) {
                    let html = `
                    <table style="width:100%; border-collapse:collapse; table-layout:fixed;">
                        <colgroup><col style="width: auto;"><col style="width: 25px;"><col style="width: 25px;"><col style="width: 15px;"><col style="width: 35px;"></colgroup>
                        <tr style="border-bottom: 1px solid rgba(0, 0, 0, 0.4);">
                            <td></td><td class="text-[8px] font-black uppercase text-black text-center"></td><td class="text-[8px] font-black uppercase text-black text-center">Arm.</td><td></td><td class="text-[8px] font-black uppercase text-black text-center">Tot.</td>
                        </tr>`;

                    talentsList.forEach(t => {
                        const isChecked = state.talents[t.id];
                        let baseScore = isChecked ? 1 : 0; 
                        let armorMalus = 0;
                        if (armorData && armorData.malus) {
                            const count = armorData.malus.filter(m => m === t.id).length;
                            armorMalus = -count;
                        }
                        let totalScore = baseScore + armorMalus;
                        const colorClass = 'text-black';

                        html += `
                        <tr style="cursor:pointer;" onclick="toggleTalent('${t.id}')" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'" onmouseout="this.style.backgroundColor='transparent'">
                            <td style="padding:4px 0; border-bottom:1px solid rgba(0,0,0,0.2); vertical-align:middle;">
                                <div class="check-box ${isChecked ? 'active' : ''}"></div>
                                <span style="font-weight:700; text-transform:uppercase; font-size:0.8rem; color:#000000; vertical-align:middle;">${t.label}</span>
                            </td>
                            <td style="padding:4px 0; border-bottom:1px solid rgba(0,0,0,0.2); text-align:center; font-weight:600; font-size:1rem; vertical-align:middle; font-family: 'Spectral', serif; color:#000000;">${baseScore}</td>
                            <td style="padding:4px 0; border-bottom:1px solid rgba(0,0,0,0.2); text-align:center; font-weight:600; font-size:1rem; vertical-align:middle; font-family: 'Spectral', serif; color:#000000;">${armorMalus}</td>
                            <td style="padding:4px 0; border-bottom:1px solid rgba(0,0,0,0.2); text-align:center; font-weight:600; font-size:1rem; vertical-align:middle; font-family: 'Spectral', serif;" class="${colorClass}">=</td>
                            <td style="padding:4px 0; border-bottom:1px solid rgba(0,0,0,0.2); text-align:center; font-weight:700; font-size:1.3rem; vertical-align:middle; font-family: 'Spectral', serif;" class="${colorClass}">${totalScore}</td>
                        </tr>`;
                    });
                    html += '</table>';
                    container.innerHTML = html;
                }
            }
        }
    </script>
</body>
</html>
