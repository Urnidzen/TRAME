<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCCS - Codex Officiel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --parchment: #f4ecd8;
            --dark-ink: #1c1917;
            --accent: #7c2d12;
            --wood-dark: #2c2520;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body { 
            height: 100%; 
            overflow: hidden; /* Emp√™che le scroll global, g√©r√© par main-container */
        }

        body {
            background-color: var(--wood-dark);
            background-image: url("https://www.transparenttextures.com/patterns/wood-pattern.png");
            font-family: 'Cormorant Garamond', serif;
            color: var(--dark-ink);
            line-height: 1.6;
        }

        h1, h2, h3, h4, .font-cinzel { font-family: 'Cinzel', serif; letter-spacing: 0.05em; }

        /* ===== SIDEBAR (Navigation) ===== */
        .sidebar-container {
            position: fixed;
            left: 0; top: 0; height: 100vh;
            z-index: 100;
            display: flex;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }

        .sidebar-container.closed { transform: translateX(-320px); }

        .sidebar {
            width: 320px;
            height: 100%;
            background: #f4ecd8;
            background-image: url("https://www.transparenttextures.com/patterns/parchment.png");
            border-right: 3px solid #1c1917;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }

        .tab-handle {
            width: 40px; height: 120px;
            background: #f5f5f0;
            border: 2px solid #1c1917;
            border-left: none;
            border-radius: 0 12px 12px 0;
            align-self: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 3px 0 10px rgba(0,0,0,0.4);
            transition: all 0.2s;
            margin-left: -2px;
        }

        .tab-handle:hover { background: #ffffff; width: 45px; }

        .tab-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            color: #1c1917;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 0.8rem;
            transform: rotate(180deg);
        }

        /* ===== SEARCH & NAV ITEMS ===== */
        .search-container { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid rgba(0,0,0,0.2); }
        .search-input { width: 100%; padding: 10px; border: 2px solid #1c1917; border-radius: 6px; background: rgba(255,255,255,0.9); font-family: 'Cormorant Garamond', serif; }
        
        .doc-item { margin-bottom: 8px; }
        .doc-header { display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .doc-header:hover { background: rgba(124, 45, 18, 0.1); }
        .doc-header.active { background: rgba(124, 45, 18, 0.2); border-left: 4px solid #7c2d12; }
        .doc-title { font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.9rem; }
        .doc-subtitle { font-size: 0.75rem; opacity: 0.7; }

        /* ===== MAIN CONTAINER (SCROLL SNAP) ===== */
        .main-container {
            margin-left: 320px;
            height: 100vh;
            width: calc(100% - 320px);
            overflow-y: scroll; /* Scroll vertical activ√© */
            scroll-snap-type: y mandatory; /* Aimantation sur l'axe Y */
            scroll-behavior: smooth;
            transition: margin-left 0.3s, width 0.3s;
            /* Cache la scrollbar pour l'immersion */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .main-container::-webkit-scrollbar { display: none; }

        .main-container.sidebar-closed { margin-left: 0; width: 100%; }

        /* ===== BOOK SPREAD (DOUBLE PAGE) ===== */
        .book-spread {
            height: 100vh; /* Force la hauteur exacte de l'√©cran */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2vh 4vw; /* Marges autour du livre */
            scroll-snap-align: start; /* Point d'accroche */
            scroll-snap-stop: always; /* Force l'arr√™t sur chaque page */
            position: relative;
        }

        .pages-visual {
            width: 100%;
            max-width: 1600px;
            height: 96vh; /* Hauteur visuelle du livre */
            background-color: #f4ecd8;
            background-image: url("https://www.transparenttextures.com/patterns/parchment.png");
            box-shadow: 
                0 0 50px rgba(0,0,0,0.7), /* Ombre externe */
                inset 0 0 100px rgba(0,0,0,0.1); /* Ombre interne "vieux papier" */
            display: flex;
            position: relative;
            border-radius: 4px;
            overflow: hidden;
        }

        /* Effet de reliure centrale (ombre au milieu) */
        .pages-visual::after {
            content: '';
            position: absolute;
            left: 50%; top: 0; bottom: 0; width: 60px;
            transform: translateX(-50%);
            background: linear-gradient(90deg, 
                rgba(0,0,0,0.05) 0%, 
                rgba(0,0,0,0.2) 45%, 
                rgba(28, 25, 23, 0.4) 50%, 
                rgba(0,0,0,0.2) 55%, 
                rgba(0,0,0,0.05) 100%);
            pointer-events: none;
            z-index: 10;
        }

        /* ===== CONTENT FLOW (Colonnes CSS) ===== */
        .content-flow {
            width: 100%;
            height: 100%;
            padding: 4rem 3rem; /* Marges int√©rieures du texte */
            
            /* C'est ici que la magie op√®re pour la double page */
            column-count: 2; 
            column-gap: 8rem; /* Espace large au milieu pour la reliure */
            column-fill: auto; /* Remplit la premi√®re colonne avant la seconde */
            
            text-align: justify;
            font-size: 1.15rem;
        }

        /* Styles sp√©cifiques pour le contenu */
        .content-flow h1 { 
            column-span: all; /* Les grands titres traversent les deux pages */
            text-align: center; 
            margin-bottom: 2rem; border-bottom: 2px solid #7c2d12; padding-bottom: 1rem;
            font-size: 2.5rem; color: #7c2d12;
        }
        
        .content-flow h2 { 
            margin-top: 1.5rem; margin-bottom: 1rem; 
            font-size: 1.8rem; border-bottom: 1px solid #1c1917; 
            break-after: avoid; /* √âvite de couper apr√®s un titre */
        }

        .content-flow p { margin-bottom: 1em; }
        
        /* Cadres et r√®gles */
        .content-card {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0,0,0,0.2);
            padding: 1rem; margin-bottom: 1rem; border-radius: 4px;
            break-inside: avoid; /* √âvite de couper une carte en deux */
        }

        .rule-box {
            border-left: 4px solid #7c2d12;
            background: rgba(124, 45, 18, 0.05);
            padding: 1rem; margin: 1rem 0;
            break-inside: avoid;
        }

        /* ===== MOBILE ADAPTATION ===== */
        @media (max-width: 1024px) {
            .sidebar-container { transform: translateX(-320px); }
            .sidebar-container.open { transform: translateX(0); }
            .main-container { margin-left: 0 !important; width: 100% !important; }
            
            .book-spread { padding: 0; height: auto; min-height: 100vh; scroll-snap-align: none; }
            .pages-visual { height: auto; min-height: 100vh; border-radius: 0; box-shadow: none; }
            .pages-visual::after { display: none; } /* Pas de reliure sur mobile */
            
            .content-flow {
                column-count: 1; /* Une seule colonne sur mobile */
                padding: 2rem 1.5rem;
                height: auto;
                column-gap: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Sidebar de navigation -->
    <div class="sidebar-container" id="sidebarContainer">
        <div class="sidebar">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Rechercher...">
            </div>
            <div id="documentsList"></div>
        </div>
        <div class="tab-handle" id="tabHandle">
            <span class="tab-text">Index</span>
        </div>
    </div>

    <!-- Conteneur principal avec Scroll Snap -->
    <div class="main-container" id="mainContainer">
        <!-- Le contenu sera inject√© ici sous forme de pages successives -->
        <div id="loadingIndicator" class="flex items-center justify-center h-full text-white font-cinzel text-xl">
            Chargement du Codex...
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const documents = [
            { id: 'intro', file: 'introduction.v0.01.html', icon: 'üìú', title: 'Introduction', subtitle: 'Bienvenue au Codex' },
            { id: 'livret1', file: 'Livret1-Mecanismes.v0.85.html', icon: '‚öôÔ∏è', title: 'Livret 1', subtitle: 'M√©canismes' },
            { id: 'livret2', file: 'Livret2-Creation.v0.74.html', icon: 'üìñ', title: 'Livret 2', subtitle: 'Cr√©ation & √âvolution' },
            { id: 'livret3', file: 'Livret3-Equipement.v0.78.html', icon: 'üõ°Ô∏è', title: 'Livret 3', subtitle: '√âquipement' },
            { id: 'livret4', file: 'Livret4-Rencontres.v0.80.html', icon: '‚öîÔ∏è', title: 'Livret 4', subtitle: 'Rencontres' },
            { id: 'livret5', file: 'Livret5-Bestiaire.v0.80.html', icon: 'üêæ', title: 'Livret 5', subtitle: 'Bestiaire' },
            { id: 'fiche', file: 'Fiche de personnage.v0.87.html', icon: 'üìù', title: 'Fiche de Personnage', subtitle: 'Interactive' },
            { id: 'contact', file: 'contact.html', icon: 'üí¨', title: 'Contact', subtitle: "Discussions" }
        ];

        // ===== ETAT =====
        let currentDocId = 'intro';
        let sidebarOpen = true;
        let isMobile = window.innerWidth <= 1024;
        let rawContentCache = ""; // Stocke le HTML brut du doc actuel pour recalculs

        function init() {
            renderDocumentsList();
            setupEventListeners();
            checkMobile();
            // Charger le premier document
            loadDocument(currentDocId);
        }

        // ===== CHARGEMENT & PAGINATION =====
        async function loadDocument(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;
            currentDocId = docId;
            renderDocumentsList();

            const container = document.getElementById('mainContainer');
            container.innerHTML = '<div class="flex items-center justify-center h-full text-white font-cinzel">Chargement...</div>';

            try {
                // Dans un environnement r√©el, fetch(doc.file). Ici simulation pour la d√©mo si fichier manquant
                let html = "";
                try {
                    const response = await fetch(doc.file);
                    if(response.ok) {
                        html = await response.text();
                    } else {
                        throw new Error("Fichier non trouv√©");
                    }
                } catch (e) {
                    // Fallback si fichiers non trouv√©s pour la d√©mo
                    html = `
                        <h1>${doc.title}</h1>
                        <h2>${doc.subtitle}</h2>
                        <p>Contenu simul√©. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor.</p>
                        ${generateDummyContent(20)}
                    `;
                }

                // Nettoyage basique
                const parser = new DOMParser();
                const docElement = parser.parseFromString(html, 'text/html');
                // Retirer les scripts et √©l√©ments UI du fichier import√©
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = docElement.body ? docElement.body.innerHTML : html;
                tempDiv.querySelectorAll('script, .sidebar, header, nav, .tab-handle').forEach(el => el.remove());
                
                rawContentCache = tempDiv.innerHTML;
                paginateContent(); // Lance la pagination magique

            } catch (error) {
                console.error("Erreur:", error);
                container.innerHTML = '<div class="p-10 text-white">Erreur de chargement.</div>';
            }
        }

        // C'est ici que la magie op√®re : D√©coupage en pages fixes
        function paginateContent() {
            const container = document.getElementById('mainContainer');
            container.innerHTML = ''; // Reset

            if (isMobile) {
                // Version Mobile : Pas de pagination complexe, juste du scroll standard
                const wrapper = document.createElement('div');
                wrapper.className = 'book-spread';
                wrapper.innerHTML = `<div class="pages-visual"><div class="content-flow">${rawContentCache}</div></div>`;
                container.appendChild(wrapper);
                return;
            }

            // Version Desktop : Pagination dynamique
            // 1. Cr√©er un conteneur temporaire pour parser les n≈ìuds
            const parserDiv = document.createElement('div');
            parserDiv.innerHTML = rawContentCache;
            const nodes = Array.from(parserDiv.childNodes); // R√©cup√®re tous les √©l√©ments (texte, div, h1...)

            // 2. Cr√©er la premi√®re page
            let currentPage = createNewPage(1);
            container.appendChild(currentPage);
            let flowContainer = currentPage.querySelector('.content-flow');

            // 3. Injecter √©l√©ment par √©l√©ment
            nodes.forEach(node => {
                // Ignorer les n≈ìuds vides (espaces, retours ligne inutiles)
                if (node.nodeType === 3 && !node.textContent.trim()) return;

                // Cloner le n≈ìud pour l'ins√©rer
                let clone = node.cloneNode(true);
                flowContainer.appendChild(clone);

                // 4. V√©rifier le d√©bordement
                // scrollHeight > clientHeight signifie que le contenu d√©passe la zone visible
                // On ajoute une tol√©rance de 5px
                if (flowContainer.scrollHeight > flowContainer.clientHeight + 5) {
                    // Retirer l'√©l√©ment qui fait d√©border
                    flowContainer.removeChild(clone);

                    // Cr√©er une NOUVELLE page
                    const pageNum = container.children.length + 1;
                    currentPage = createNewPage(pageNum);
                    container.appendChild(currentPage);
                    
                    // Ajouter l'√©l√©ment dans la nouvelle page
                    flowContainer = currentPage.querySelector('.content-flow');
                    flowContainer.appendChild(clone);
                }
            });

            // Petit d√©lai pour scroller en haut apr√®s le calcul
            setTimeout(() => {
                if(container.children[0]) container.children[0].scrollIntoView();
            }, 100);
        }

        function createNewPage(pageNum) {
            const spread = document.createElement('div');
            spread.className = 'book-spread';
            spread.id = `page-${pageNum}`;
            spread.innerHTML = `
                <div class="pages-visual">
                    <div class="content-flow">
                        <!-- Le contenu sera inject√© ici -->
                    </div>
                </div>
            `;
            return spread;
        }

        function generateDummyContent(paragraphs) {
            let s = "";
            for(let i=0; i<paragraphs; i++) {
                s += `<p class="mb-4">Section ${i+1}. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat. Duis semper. Duis arcu massa, scelerisque vitae, consequat in, pretium a, enim. Pellentesque congue.</p>`;
                if (i % 5 === 0 && i > 0) s += `<div class="rule-box">R√®gle Sp√©ciale #${i}: Une note importante encadr√©e.</div>`;
                if (i % 8 === 0 && i > 0) s += `<h2>Chapitre Nouveau ${i}</h2>`;
            }
            return s;
        }

        // ===== NAVIGATION & EVENTS =====
        function renderDocumentsList() {
            const list = document.getElementById('documentsList');
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            list.innerHTML = documents.map(doc => {
                if(term && !doc.title.toLowerCase().includes(term)) return '';
                const active = doc.id === currentDocId ? 'active' : '';
                return `
                    <div class="doc-item">
                        <div class="doc-header ${active}" onclick="loadDocument('${doc.id}')">
                            <span class="doc-icon text-xl">${doc.icon}</span>
                            <div>
                                <div class="doc-title">${doc.title}</div>
                                <div class="doc-subtitle">${doc.subtitle}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            document.getElementById('sidebarContainer').classList.toggle('closed', !sidebarOpen);
            document.getElementById('mainContainer').classList.toggle('sidebar-closed', !sidebarOpen);
        }

        function checkMobile() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 1024;
            
            // Si on change de mode (Mobile <-> Desktop), on doit relancer la pagination
            if (wasMobile !== isMobile) {
                if(rawContentCache) paginateContent();
            }

            if (isMobile && sidebarOpen) toggleSidebar();
        }

        // Debounce pour le redimensionnement (√©vite de calculer 100 fois par seconde)
        let resizeTimer;
        function onResize() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                checkMobile();
                if (!isMobile && rawContentCache) {
                    paginateContent(); // Recalculer les pages si on redimensionne la fen√™tre
                }
            }, 200);
        }

        function setupEventListeners() {
            document.getElementById('tabHandle').addEventListener('click', toggleSidebar);
            document.getElementById('searchInput').addEventListener('input', renderDocumentsList);
            window.addEventListener('resize', onResize);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
